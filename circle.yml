machine:
  java:
    version: oraclejdk8
  environment:
    BUILD_NUM: $CIRCLE_BUILD_NUM
    COMMIT_HASH: ${CIRCLE_SHA1:0:7}
checkout:
  post:
    - ./ci/update-version.sh
dependencies:
  override:
    - nvm install && ./ci/dependencies.sh
compile:
  override:
    - nvm use && ./ci/compile.sh
test:
  override:
    - nvm use && ./ci/test.sh
  post:
    - mkdir -p $CIRCLE_TEST_REPORTS/client/
    - find . -type f -regex ".*/target/client/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/client/ \;
    - mkdir -p $CIRCLE_TEST_REPORTS/server/
    - find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/server/ \;
deployment:
  staging:
    branch: master
    owner: build-canaries
    commands:
      - ./ci/deploy.sh
      - ./lein.sh test functional.functional-test
            environment:
              FUNCTIONAL_URL: https://staging.nevergreen.io
              TRAY_USERNAME:
              TRAY_PASSWORD:
              TRAY_URL: https://drive.google.com/uc?export=download&id=0BzdMs1jfanaARkJJX1VRR2QtdTA
#  production:
#    tag: /v[0-9]+(\.[0-9]+)*/
#    owner: build-canaries
#    commands:
#      - ./ci/release.sh
general:
  artifacts:
    - ./target/nevergreen-standalone.jar
